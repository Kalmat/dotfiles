From ca9aba10b67f74e830bc7586a2da8fb3c2a0cb61 Mon Sep 17 00:00:00 2001
From: nagao_hiroki <nagao_hiroki@hand.co.jp>
Date: Mon, 20 Apr 2015 09:48:11 +0900
Subject: [PATCH] Fix Japanese language

---
 autoload/OmniSharp.vim | 11 ++++++++++-
 python/OmniSharp.py    |  4 +---
 python/asyncrequest.py |  2 +-
 python/syncrequest.py  |  2 +-
 4 files changed, 13 insertions(+), 6 deletions(-)

diff --git a/autoload/OmniSharp.vim b/autoload/OmniSharp.vim
index ce1e71d..10fd92c 100644
--- a/autoload/OmniSharp.vim
+++ b/autoload/OmniSharp.vim
@@ -16,7 +16,7 @@ function! OmniSharp#Complete(findstart, base) abort
     "locate the start of the word
     let line = getline('.')
     let start = col('.') - 1
-    let s:textBuffer = getline(1, '$')
+	let s:textBuffer = OmniSharp#GetUTF8Line()
     while start > 0 && line[start - 1] =~# '\v[a-zA-z0-9_]'
       let start -= 1
     endwhile
@@ -605,5 +605,14 @@ function! OmniSharp#AppendCtrlPExtensions() abort
   endif
 endfunction
 
+function! OmniSharp#GetUTF8Line()
+	let s:lines = getline(1,'$')
+	let s:utf8lines = []
+	for line in s:lines
+		call add(s:utf8lines, iconv(line, &encoding, 'utf-8'))
+	endfor
+	return s:utf8lines
+endfunction
+
 let &cpo = s:save_cpo
 unlet s:save_cpo
diff --git a/python/OmniSharp.py b/python/OmniSharp.py
index 349ffa5..942ec2e 100644
--- a/python/OmniSharp.py
+++ b/python/OmniSharp.py
@@ -18,7 +18,7 @@ def getResponse(endPoint, additional_parameters=None, timeout=None):
     parameters = {}
     parameters['line'] = vim.eval('line(".")')
     parameters['column'] = vim.eval('col(".")')
-    parameters['buffer'] = '\r\n'.join(vim.eval("getline(1,'$')")[:])
+    parameters['buffer'] = '\r\n'.join(vim.eval('OmniSharp#GetUTF8Line()')[:])
     parameters['filename'] = vim.current.buffer.name
     if additional_parameters != None:
         parameters.update(additional_parameters)
@@ -109,7 +109,6 @@ def setBufferText(text):
     lines = text.splitlines()
 
     cursor = vim.current.window.cursor
-    lines = [line.encode('utf-8') for line in lines]
     vim.current.buffer[:] = lines
     vim.current.window.cursor = cursor
 
@@ -163,7 +162,6 @@ def renameTo():
 
 def setBuffer(buffer):
     lines = buffer.splitlines()
-    lines = [line.encode('utf-8') for line in lines]
     vim.current.buffer[:] = lines
 
 def build(ret):
diff --git a/python/asyncrequest.py b/python/asyncrequest.py
index 8ab1048..156ddab 100644
--- a/python/asyncrequest.py
+++ b/python/asyncrequest.py
@@ -26,7 +26,7 @@ def get_response_async(endPoint, callback, params=None, timeout=None):
     parameters = {}
     parameters['line'] = vim.eval('line(".")')
     parameters['column'] = vim.eval('col(".")')
-    parameters['buffer'] = '\r\n'.join(vim.eval("getline(1,'$')")[:])
+    parameters['buffer'] = '\r\n'.join(vim.eval('OmniSharp#GetUTF8Line()')[:])
     parameters['filename'] = vim.current.buffer.name
 
     if params is not None:
diff --git a/python/syncrequest.py b/python/syncrequest.py
index 5630ef3..c1f5f3b 100644
--- a/python/syncrequest.py
+++ b/python/syncrequest.py
@@ -4,7 +4,7 @@ def get_response(endPoint, params=None, timeout=None):
     parameters = {}
     parameters['line'] = vim.eval('line(".")')
     parameters['column'] = vim.eval('col(".")')
-    parameters['buffer'] = '\r\n'.join(vim.eval("getline(1,'$')")[:])
+    parameters['buffer'] = '\r\n'.join(vim.eval('OmniSharp#GetUTF8Line()')[:])
     parameters['filename'] = vim.current.buffer.name
 
     if params is not None:
-- 
1.9.5.msysgit.1

